###############################################################################
#                                                                             #
# IAR ANSI C/C++ Compiler V6.30.6.53336/W32 for ARM     26/Apr/2013  16:24:09 #
# Copyright 1999-2012 IAR Systems AB.                                         #
#                                                                             #
#    Cpu mode     =  arm                                                      #
#    Endian       =  little                                                   #
#    Source file  =  C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구          #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91lib\peripherals\tc\tc.c                   #
#    Command line =  "C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구         #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91lib\peripherals\tc\tc.c" -D               #
#                    at91sam7se512 -D sram -D TRACE_LEVEL=4 -lC               #
#                    "C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구         #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91sam7se-ek\basic-usart-hw-handshaking-proj #
#                    ect\ewp\at91sam7se512_sram\List\" --remarks              #
#                    --diag_suppress Pe826,Pe1375 -o                          #
#                    "C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구         #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91sam7se-ek\basic-usart-hw-handshaking-proj #
#                    ect\ewp\at91sam7se512_sram\Obj\" --no_cse --no_unroll    #
#                    --no_inline --no_code_motion --no_tbaa --no_clustering   #
#                    --no_scheduling --debug --endian=little --cpu=ARM7TDMI   #
#                    -e --fpu=None --dlib_config "C:\Program Files\IAR        #
#                    Systems\Embedded Workbench 6.0\arm\INC\c\DLib_Config_Ful #
#                    l.h" -I "C:\Users\JDS\Desktop\JDS_PRO\국내               #
#                    프로젝트\대구 모노레일\프로그램\basic-usart-hw-handshaki #
#                    ng-project-at91sam7se-ek\at91sam7se-ek\basic-usart-hw-ha #
#                    ndshaking-project\ewp\..\..\..\at91lib/peripherals\" -I  #
#                    "C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구         #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91sam7se-ek\basic-usart-hw-handshaking-proj #
#                    ect\ewp\..\..\..\at91lib\" -I                            #
#                    "C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구         #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91sam7se-ek\basic-usart-hw-handshaking-proj #
#                    ect\ewp\..\..\..\at91lib/components\" -I                 #
#                    "C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구         #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91sam7se-ek\basic-usart-hw-handshaking-proj #
#                    ect\ewp\..\..\..\at91lib/boards/at91sam7se-ek\"          #
#                    --interwork --cpu_mode arm -Oh --use_c++_inline          #
#    List file    =  C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구          #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91sam7se-ek\basic-usart-hw-handshaking-proj #
#                    ect\ewp\at91sam7se512_sram\List\tc.lst                   #
#    Object file  =  C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구          #
#                    모노레일\프로그램\basic-usart-hw-handshaking-project-at9 #
#                    1sam7se-ek\at91sam7se-ek\basic-usart-hw-handshaking-proj #
#                    ect\ewp\at91sam7se512_sram\Obj\tc.o                      #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\JDS\Desktop\JDS_PRO\국내 프로젝트\대구 모노레일\프로그램\basic-usart-hw-handshaking-project-at91sam7se-ek\at91lib\peripherals\tc\tc.c
      1          /* ----------------------------------------------------------------------------
      2           *         ATMEL Microcontroller Software Support 
      3           * ----------------------------------------------------------------------------
      4           * Copyright (c) 2008, Atmel Corporation
      5           *
      6           * All rights reserved.
      7           *
      8           * Redistribution and use in source and binary forms, with or without
      9           * modification, are permitted provided that the following conditions are met:
     10           *
     11           * - Redistributions of source code must retain the above copyright notice,
     12           * this list of conditions and the disclaimer below.
     13           *
     14           * Atmel's name may not be used to endorse or promote products derived from
     15           * this software without specific prior written permission.
     16           *
     17           * DISCLAIMER: THIS SOFTWARE IS PROVIDED BY ATMEL "AS IS" AND ANY EXPRESS OR
     18           * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
     19           * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT ARE
     20           * DISCLAIMED. IN NO EVENT SHALL ATMEL BE LIABLE FOR ANY DIRECT, INDIRECT,
     21           * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
     22           * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
     23           * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
     24           * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
     25           * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
     26           * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
     27           * ----------------------------------------------------------------------------
     28           */
     29          
     30          //------------------------------------------------------------------------------
     31          //         Headers
     32          //------------------------------------------------------------------------------
     33          
     34          #include "tc.h"
     35          
     36          //------------------------------------------------------------------------------
     37          //         Global Functions
     38          //------------------------------------------------------------------------------
     39          
     40          //------------------------------------------------------------------------------
     41          /// Configures a Timer Counter to operate in the given mode. Timer is stopped
     42          /// after configuration and must be restarted with TC_Start(). All the
     43          /// interrupts of the timer are also disabled.
     44          /// \param pTc  Pointer to an AT91S_TC instance.
     45          /// \param mode  Operating mode (TC_CMR value).
     46          //------------------------------------------------------------------------------

   \                                 In section .text, align 4, keep-with-next
     47          void TC_Configure(AT91S_TC *pTc, unsigned int mode)
     48          {
     49              // Disable TC clock
     50              pTc->TC_CCR = AT91C_TC_CLKDIS;
   \                     TC_Configure:
   \   00000000   0xE3A02002         MOV      R2,#+2
   \   00000004   0xE5802000         STR      R2,[R0, #+0]
     51          
     52              // Disable interrupts
     53              pTc->TC_IDR = 0xFFFFFFFF;
   \   00000008   0xE3E02000         MVN      R2,#+0
   \   0000000C   0xE5802028         STR      R2,[R0, #+40]
     54          
     55              // Clear status register
     56              pTc->TC_SR;
   \   00000010   0xE5902020         LDR      R2,[R0, #+32]
     57          
     58              // Set mode
     59              pTc->TC_CMR = mode;
   \   00000014   0xE5801004         STR      R1,[R0, #+4]
     60          }
   \   00000018   0xE12FFF1E         BX       LR               ;; return
     61          
     62          //------------------------------------------------------------------------------
     63          /// Enables the timer clock and performs a software reset to start the counting.
     64          /// \param pTc  Pointer to an AT91S_TC instance.
     65          //------------------------------------------------------------------------------

   \                                 In section .text, align 4, keep-with-next
     66          void TC_Start(AT91S_TC *pTc)
     67          {
     68              pTc->TC_CCR = AT91C_TC_CLKEN | AT91C_TC_SWTRG;
   \                     TC_Start:
   \   00000000   0xE3A01005         MOV      R1,#+5
   \   00000004   0xE5801000         STR      R1,[R0, #+0]
     69          }
   \   00000008   0xE12FFF1E         BX       LR               ;; return
     70          
     71          //------------------------------------------------------------------------------
     72          /// Disables the timer clock, stopping the counting.
     73          /// \param pTc  Pointer to an AT91S_TC instance.
     74          //------------------------------------------------------------------------------

   \                                 In section .text, align 4, keep-with-next
     75          void TC_Stop(AT91S_TC *pTc)
     76          {
     77              pTc->TC_CCR = AT91C_TC_CLKDIS;
   \                     TC_Stop:
   \   00000000   0xE3A01002         MOV      R1,#+2
   \   00000004   0xE5801000         STR      R1,[R0, #+0]
     78          }
   \   00000008   0xE12FFF1E         BX       LR               ;; return
     79          
     80          //------------------------------------------------------------------------------
     81          /// Finds the best MCK divisor given the timer frequency and MCK. The result
     82          /// is guaranteed to satisfy the following equation:
     83          /// \pre
     84          ///   (MCK / (DIV * 65536)) <= freq <= (MCK / DIV)
     85          /// \endpre
     86          /// with DIV being the highest possible value.
     87          /// \param freq  Desired timer frequency.
     88          /// \param mck  Master clock frequency.
     89          /// \param div  Divisor value.
     90          /// \param tcclks  TCCLKS field value for divisor.
     91          /// \return 1 if a proper divisor has been found; otherwise 0.
     92          //------------------------------------------------------------------------------

   \                                 In section .text, align 4, keep-with-next
     93          unsigned char TC_FindMckDivisor(
     94              unsigned int freq,
     95              unsigned int mck,
     96              unsigned int *div,
     97              unsigned int *tcclks)
     98          {
   \                     TC_FindMckDivisor:
   \   00000000   0xE92D43F0         PUSH     {R4-R9,LR}
   \   00000004   0xE24DD014         SUB      SP,SP,#+20
   \   00000008   0xE1A04000         MOV      R4,R0
   \   0000000C   0xE1A05001         MOV      R5,R1
   \   00000010   0xE1A06002         MOV      R6,R2
   \   00000014   0xE1A07003         MOV      R7,R3
     99              const unsigned int divisors[5] = {2, 8, 32, 128,
    100          #if defined(at91sam9260) || defined(at91sam9261) || defined(at91sam9263) \
    101              || defined(at91sam9xe) || defined(at91sam9rl64) || defined(at91cap9)
    102                  BOARD_MCK / 32768};
    103          #else
    104                  1024};
   \   00000018   0xE1A0000D         MOV      R0,SP
   \   0000001C   0x........         LDR      R1,??DataTable0
   \   00000020   0xE8B1510C         LDM      R1!,{R2,R3,R8,R12,LR}
   \   00000024   0xE8A0510C         STM      R0!,{R2,R3,R8,R12,LR}
    105          #endif
    106              unsigned int index = 0;
   \   00000028   0xE3A08000         MOV      R8,#+0
   \   0000002C   0xE1A0900D         MOV      R9,SP
    107          
    108              // Satisfy lower bound
    109              while (freq < ((mck / divisors[index]) / 65536)) {
   \                     ??TC_FindMckDivisor_0:
   \   00000030   0xE1A00005         MOV      R0,R5
   \   00000034   0xE4991004         LDR      R1,[R9], #+4
   \   00000038   0x........         BL       __aeabi_uidiv
   \   0000003C   0xE1540820         CMP      R4,R0, LSR #+16
   \   00000040   0x2A000005         BCS      ??TC_FindMckDivisor_1
    110          
    111                  index++;
   \   00000044   0xE2888001         ADD      R8,R8,#+1
    112          
    113                  // If no divisor can be found, return 0
    114                  if (index == 5) {
   \   00000048   0xE3580005         CMP      R8,#+5
   \   0000004C   0x1AFFFFF7         BNE      ??TC_FindMckDivisor_0
    115          
    116                      return 0;
   \   00000050   0xE3A00000         MOV      R0,#+0
   \   00000054   0xEA00000E         B        ??TC_FindMckDivisor_2
    117                  }
    118              }
    119          
    120              // Try to maximise DIV while satisfying upper bound
    121              while (index < 4) {
    122          
    123                  if (freq > (mck / divisors[index + 1])) {
    124          
    125                      break;
    126                  }
    127                  index++;
   \                     ??TC_FindMckDivisor_3:
   \   00000058   0xE2888001         ADD      R8,R8,#+1
   \                     ??TC_FindMckDivisor_1:
   \   0000005C   0xE3580004         CMP      R8,#+4
   \   00000060   0x2A000005         BCS      ??TC_FindMckDivisor_4
   \   00000064   0xE1A00005         MOV      R0,R5
   \   00000068   0xE08D1108         ADD      R1,SP,R8, LSL #+2
   \   0000006C   0xE5911004         LDR      R1,[R1, #+4]
   \   00000070   0x........         BL       __aeabi_uidiv
   \   00000074   0xE1500004         CMP      R0,R4
   \   00000078   0x2AFFFFF6         BCS      ??TC_FindMckDivisor_3
    128              }
    129          
    130              // Store results
    131              if (div) {
   \                     ??TC_FindMckDivisor_4:
   \   0000007C   0xE3560000         CMP      R6,#+0
    132          
    133                  *div = divisors[index];
   \   00000080   0x179D0108         LDRNE    R0,[SP, +R8, LSL #+2]
   \   00000084   0x15860000         STRNE    R0,[R6, #+0]
    134              }
    135              if (tcclks) {
   \   00000088   0xE3570000         CMP      R7,#+0
    136          
    137                  *tcclks = index;
   \   0000008C   0x15878000         STRNE    R8,[R7, #+0]
    138              }
    139          
    140              return 1;
   \   00000090   0xE3A00001         MOV      R0,#+1
   \                     ??TC_FindMckDivisor_2:
   \   00000094   0xE28DD014         ADD      SP,SP,#+20       ;; stack cleaning
   \   00000098   0xE8BD43F0         POP      {R4-R9,LR}
   \   0000009C   0xE12FFF1E         BX       LR               ;; return
    141          }

   \                                 In section .text, align 4, keep-with-next
   \                     ??DataTable0:
   \   00000000   0x........         DC32     `?<Constant {2, 8, 32, 128, 1024}>`

   \                                 In section .rodata, align 4
   \                     `?<Constant {2, 8, 32, 128, 1024}>`:
   \   00000000   0x00000002         DC32 2, 8, 32, 128, 1024
   \              0x00000008   
   \              0x00000020   
   \              0x00000080   
   \              0x00000400   
    142          

   Maximum stack usage in bytes:

   .cstack Function
   ------- --------
        0  TC_Configure
       48  TC_FindMckDivisor
             48 -> __aeabi_uidiv
        0  TC_Start
        0  TC_Stop


   Section sizes:

   Bytes  Function/Label
   -----  --------------
      20  ?<Constant {2, 8, 32, 128, 1024}>
       4  ??DataTable0
      28  TC_Configure
     160  TC_FindMckDivisor
      12  TC_Start
      12  TC_Stop

 
  20 bytes in section .rodata
 216 bytes in section .text
 
 216 bytes of CODE  memory
  20 bytes of CONST memory

Errors: none
Warnings: none
